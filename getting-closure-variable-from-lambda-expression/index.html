<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MKMT587M');</script>
    <!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Getting closure variable's data from lambda expression in C# - Egor Grishechko's Blog</title>
    <meta name="description" content="How to get closure variable's data from lambda expression with reflection">
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MKMT587M"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <header>
        <nav>
            <a href="/" class="logo">Egor Grishechko</a>
            <a href="/">Home</a>
        </nav>
    </header>

    <main>
        <article class="post">
            <header class="post-header">
                <h1>Getting closure variable's data from lambda expression in C#</h1>
                <div class="post-meta">
                    <time datetime="2017-05-21">May 21, 2017</time>
                    <div class="tags"><span class="tag">unit-tests</span> <span class="tag">reflection</span></div>
                </div>
            </header>

            <div class="post-content">
                <p>Hi everyone! Today I want to talk about closures and extracting their values from lamda expression.</p>

<h3>The problem</h3>
One of my project has a lot of <code>Action</code> and <code>Func</code> delegates as parameters for methods. It has them everyevere and I got a task to write some unit-tests for some of these methods.
Let's imagine that there is a method that take <code>Action</code> like a parameter.

``<code>csharp 			
        public void Execute(Action action)
        {
            //... Some code
            action();
            //... Some code
        }
<pre><code>
The delegate can be initialised with lambda expression.

</code></pre>csharp 			
        var thisIsClosure = "ThisIsClosure";
        Action actionWithClosure = () =>
        {
            Сonsole.WriteLine(thisIsClosure);
        };
<pre><code>
So, we call them in a way like in a snippet below.

</code></pre>csharp 			
	Execute(actionWithClosure);
<pre><code>
<h3>What I did</h3>

Because I was writing unit-tests I had to get some values from </code>Action<code> for </code>Asserts<code>.
But It tended to be a real problem, because I couldn&#39;t use </code>Expression<code>, because code smells when you change it for testing reasons.

<strong>Please Note:</strong>  If you change your code, due to some unit-tests reasons, it&#39;s the awful practice. Please, don&#39;t do this.

So, I decided to write a simple parser with using of </code>Reflection<code>.

</code></pre>csharp 			
    public static class LambdaVariableExtractor
    {
        public static TValue ExtractValue<TValue>(
		this Delegate lambda, 
		string variableName)
            where TValue : class
        {
            if (lambda == null)
                throw new NullReferenceException("Empty lambda");

            var field = lambda.Method.DeclaringType?.GetFields
                (
                    BindingFlags.NonPublic |
                    BindingFlags.Instance |
                    BindingFlags.Public |
                    BindingFlags.Static
                )
                .Single(x => x.Name == name);

            if (field == null)
                throw new NullReferenceException("There isn't a variable with this name");

            return field.GetValue(lambda.Target) as TValue;
        }
    }
</code>`<code>

In this code, first of all we check lambda expression for exisiting and then do some magic.
What is a </code>DeclaringType<code> in this context? For uderstanding this, we should take a short look on some parts of C# specification.

As we all know, lambda expressions are just sugar.

<strong>7.15 Anonymous function expressions</strong> 
An anonymous function is an expression that represents an “in-line” method definition. 
An anonymous function does not have a value or type in and of itself, but is convertible to a compatible delegate or expression tree type. 
The evaluation of an anonymous function conversion depends on the target type of the conversion: 
If it is a delegate type, the conversion evaluates to a delegate value referencing the method which the anonymous function defines. 
<a href="https://docs.microsoft.com/en-us/dotnet/articles/csharp/language-reference/language-specification">specification</a>

In this context lambda is some kind of anonymous function. Let's take a look, how compilator doing some job for us.

<figure><a href="/assets/images/ilspy-lamda.png"><img src="/assets/images/ilspy-lamda.png" alt="Generated class"></a><figcaption>Generated class</figcaption></figure>

There is a class named the strange name </code><>c__DisplayClass0_0<code> in the picture. And this is a class which was generated by compilator.
Usually this class contains only your lambda as a method. But sometimes, when you have closures it starts to contain some variable.
In example, you can see that there is </code>thisIsClosure<code> variable there.

So, </code>DeclaringType<code> returns </code>Type<code> for this generated class. After that it's easy to fetch fields of this class.
And the last thing, If you want to get values from these fields you should pass </code>Target<code> as the parameter to the </code>GetValue<code> function.
</code>Target<code> keeps reference to the object of the generated class and we need to pass it for right working of </code>Reflection`.

You can find this example's code on <a href="https://github.com/egorikas/LambdaVariableExtractor">github</a>.

<h3>Conclusion</h3>

That's all. I'll be happy, If this article helps you.
            </div>
        </article>
    </main>

    <footer>
        <p>&copy; 2026 Egor Grishechko. All rights reserved.</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
</body>
</html>